---
phase: 002-csi-komponent
plan: 03
type: execute
wave: 3
depends_on: ["002-02"]
files_modified:
  - prosebya-prototype-iframe.html
  - assets/csi/csi-bootstrap.js
autonomous: false
must_haves:
  truths:
    - "CSI смонтирован в #csi-overlay-root при загрузке страницы"
    - "Баннер показывается только на /lk при выполнении критериев"
    - "Полный флоу: баннер → форма → submit → success/error работает"
    - "Retry восстанавливает форму с данными, Cancel закрывает"
    - "CTA «У меня срочный вопрос» выполняет переход"
  artifacts:
    - path: prosebya-prototype-iframe.html
      provides: Хост с подключённым CSI
      contains: "csi-bootstrap|assets/csi"
    - path: assets/csi/csi-bootstrap.js
      provides: Точка входа, монтирование CSI
      min_lines: 30
  key_links:
    - from: assets/csi/csi-bootstrap.js
      to: "#csi-overlay-root"
      via: "document.getElementById + renderCSI"
      pattern: "csi-overlay-root|renderCSI"
---

<objective>
Интегрировать CSI в prosebya-prototype-iframe.html: подключить скрипты, обеспечить pointer-events для кликабельности, смонтировать компонент. Верифицировать полный флоу через checkpoint.
</objective>

<execution_context>
@/Users/valeriatkaceva/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valeriatkaceva/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/002-csi-komponent/002-RESEARCH.md
@prosebya-prototype-iframe.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bootstrap и подключение в HTML</name>
  <files>assets/csi/csi-bootstrap.js, prosebya-prototype-iframe.html</files>
  <action>
1. Создать csi-bootstrap.js: при DOMContentLoaded найти #csi-overlay-root, проверить shouldShowBanner (через CSIController + isLkPage). Если показать — добавить pointer-events: auto на .prototype-overlay или создать .csi-root с pointer-events: auto внутри overlay. Импортировать renderCSI из csi-ui.js, вызвать renderCSI(container). Контейнер должен быть дочерним для #csi-overlay-root.

2. В prosebya-prototype-iframe.html: добавить link на assets/csi/csi.css, script на assets/csi/csi-state.js, csi-api.js, csi-ui.js, csi-bootstrap.js (в этом порядке). Либо один csi-bootstrap.js подгружает остальные динамически — для простоты прототипа лучше явные script в head/body.

3. .prototype-overlay имеет pointer-events: none — CSI-элементы (.csi-root) должны иметь pointer-events: auto. Либо изменить .prototype-overlay на pointer-events: auto и ограничить клики только CSI (баннер+попап), либо обернуть CSI в div с pointer-events: auto. RESEARCH: overlay pointer-events: none, CSI elements pointer-events: auto.
</action>
  <verify>Открыть prosebya-prototype-iframe.html в браузере — баннер виден в правом нижнем углу, кликабелен</verify>
  <done>CSI смонтирован и отображается на странице</done>
</task>

<task type="auto">
  <name>Task 2: Связка state machine с API и UI</name>
  <files>assets/csi/csi-ui.js, assets/csi/csi-state.js</files>
  <action>
Убедиться что при transition('submit'):
1. CSIController вызывает submitSurvey из csi-api.js с { rating, comment }
2. При успехе — transition в SUCCESS_4_5 или SUCCESS_1_3 по isHighRating(rating)
3. При ошибке — transition в ERROR, сохранить draft для Retry
4. csi-ui.js подписан на изменения state и перерисовывает попап

Если связка уже реализована в Plan 01–02 — проверить и при необходимости доработать. Ключевое: submitSurvey вызывается из csi-state при submit, результат определяет переход.
</action>
  <verify>Отправка формы вызывает submitSurvey, при ok переход в success, при error — в error с Retry/Cancel</verify>
  <done>State machine корректно связана с mock API и UI</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Верификация полного флоу</name>
  <files>prosebya-prototype-iframe.html</files>
  <action>Человек выполняет верификацию по шагам из how-to-verify</action>
  <verify>Пользователь открывает prosebya-prototype-iframe.html, проходится по всем веткам флоу, вводит «approved» или описывает проблемы</verify>
  <done>Все ветки флоу (4–5, 1–3, error, Retry, Cancel) проверены пользователем</done>
  <what-built>CSI-компонент: баннер, попап, форма, success/error экраны, mock API</what-built>
  <how-to-verify>
1. Открыть prosebya-prototype-iframe.html в браузере (file:// или через local server)
2. Убедиться: баннер в правом нижнем углу
3. Клик по баннеру — открывается попап с оценкой 1–5 и полем комментария
4. Выбрать оценку 5, нажать «Сохранить» — экран «Спасибо» + «Закрыть»
5. Повторить с оценкой 2 — экран «Спасибо» + «У меня срочный вопрос» + «Закрыть»
6. Для теста error: в csi-api.js временно forceError или словить network — экран ошибки, Retry (форма с данными), Cancel (закрытие)
7. Проверить: комментарий лимит 1000 символов; клик вне попапа НЕ закрывает его
  </how-to-verify>
  <resume-signal>Напишите «approved» или опишите найденные проблемы</resume-signal>
</task>

</tasks>

<verification>
- [ ] CSI смонтирован в #csi-overlay-root
- [ ] Баннер → форма → submit → success (4–5 и 1–3) и error (Retry/Cancel) работают
- [ ] Ограничения RESEARCH соблюдены: /lk only, no skeletons, comment 1000, no click-outside-close, branching, retry/cancel, CTA
</verification>

<success_criteria>
- CSI полностью интегрирован и работоспособен
- Все ветки флоу пройдены верификацией
</success_criteria>

<output>
После выполнения создать .planning/phases/002-csi-komponent/002-03-SUMMARY.md
</output>
