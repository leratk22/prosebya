---
phase: 002-csi-komponent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/csi/csi-state.js
  - assets/csi/csi-api.js
autonomous: true
must_haves:
  truths:
    - "State machine manages transitions: hidden → banner → form → submitting → success/error"
    - "Banner visibility depends on /lk page + at least one criterion (phone login, 3+ consultations, etc.)"
    - "Branching 4–5 vs 1–3 determines which success screen to show"
    - "Banner hidden after successful submit"
  artifacts:
    - path: assets/csi/csi-state.js
      provides: CSI state machine and visibility logic
      min_lines: 80
    - path: assets/csi/csi-api.js
      provides: Mock submit API for prototype
      exports: ["submitSurvey"]
  key_links:
    - from: assets/csi/csi-state.js
      to: assets/csi/csi-api.js
      via: "import/call submitSurvey"
      pattern: "submitSurvey|csi-api"
---

<objective>
Реализовать каркас состояния и логики CSI: state machine, критерии показа баннера, ветвление по оценке, mock API для прототипа.
</objective>

<execution_context>
@/Users/valeriatkaceva/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valeriatkaceva/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/002-csi-komponent/002-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: State machine и критерии показа баннера</name>
  <files>assets/csi/csi-state.js</files>
  <action>
Создать csi-state.js с явной state machine:

1. Состояния: HIDDEN, BANNER, FORM, SUBMITTING, ERROR, SUCCESS_4_5, SUCCESS_1_3
2. Экспорт объекта/класса CSIController с методами: getState(), transition(event), getVisibilityFlags()
3. Критерии показа баннера (только на /lk): shouldShowBanner(flags) возвращает true если хотя бы одно:
   - loginByPhone: true
   - consultationsCount >= 3
   - contentViewsCount >= 2
   - loginCount >= 3
4. В прототипе — заглушки: { loginByPhone: true, consultationsCount: 3, contentViewsCount: 2, loginCount: 3 } (все true для демо)
5. Проверка страницы: isLkPage() — считать /lk если URL pathname содержит '/lk' или текущая страница — prosebya-prototype-iframe.html (iframe src lk.prosebya.ru)
6. После успешного submit баннер больше не показывается — флаг hasSubmitted: true блокирует показ
7. Ветвление: isHighRating(rating) => rating >= 4
8. Экспорт констант: CSI_STATES, CHAT_SUPPORT_URL (placeholder '#', для кнопки «У меня срочный вопрос»)
9. Хранение draft: при переходе в ERROR сохранять { rating, comment } в lastDraft для Retry (getDraft/setDraft или поле в контроллере)
</action>
  <verify>Файл существует, содержит CSI_STATES и CSIController, grep "shouldShowBanner|isHighRating|HIDDEN|BANNER|FORM" находит все ключевые элементы</verify>
  <done>State machine и visibility logic реализованы, экспортируются и готовы к использованию UI</done>
</task>

<task type="auto">
  <name>Task 2: Mock API для submit</name>
  <files>assets/csi/csi-api.js</files>
  <action>
Создать csi-api.js с mock submit:

1. submitSurvey({ rating: 1..5, comment?: string }) => Promise&lt;{ ok: boolean, error?: string }&gt;
2. Искусственная задержка 800–1200 ms
3. Успех: ok: true (всегда для прототипа, либо симулировать ошибку с prob 0.1 для теста Retry)
4. Ошибка: ok: false, error: "Ошибка сети" — для тестирования Retry/Cancel можно вызвать submitSurvey с флагом forceError: true
5. Экспорт submitSurvey — единственная публичная функция
6. Конфиг: CSI_API_BASE (пустая строка для mock), вынести в начало файла для последующей замены на реальный API
</action>
  <verify>Файл существует, submitSurvey экспортирована, вызов submitSurvey({rating:5}) возвращает Promise с ok:true после задержки</verify>
  <done>Mock API готов к интеграции с state machine</done>
</task>

</tasks>

<verification>
- [ ] assets/csi/csi-state.js существует, экспортирует CSIController, CSI_STATES, shouldShowBanner, isHighRating
- [ ] assets/csi/csi-api.js существует, submitSurvey({rating:4}) resolves с {ok:true}
- [ ] Нет скелетонов, нет лишних зависимостей
</verification>

<success_criteria>
- State machine и mock API реализованы и изолированы
- Критерии показа баннера и ветвление 4–5 vs 1–3 соответствуют RESEARCH
- Готово к подключению UI (Plan 02)
</success_criteria>

<output>
После выполнения создать .planning/phases/002-csi-komponent/002-01-SUMMARY.md
</output>
