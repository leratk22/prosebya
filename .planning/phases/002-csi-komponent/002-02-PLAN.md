---
phase: 002-csi-komponent
plan: 02
type: execute
wave: 2
depends_on: ["002-01"]
files_modified:
  - assets/csi/csi-ui.js
  - assets/csi/csi.css
autonomous: true
must_haves:
  truths:
    - "Баннер отображается в правом нижнем углу с default и hover состояниями"
    - "Попап с формой: оценка 1–5, комментарий до 1000 символов, кнопка Сохранить"
    - "Success 4–5: «Спасибо» + кнопка Закрыть"
    - "Success 1–3: «Спасибо» + CTA «У меня срочный вопрос»"
    - "Error: Retry и Cancel"
    - "Клик вне попапа НЕ закрывает его"
  artifacts:
    - path: assets/csi/csi-ui.js
      provides: Рендер баннера, попапа, success/error экранов
      min_lines: 150
    - path: assets/csi/csi.css
      provides: Figma-токены и стили CSI
      contains: "--csi-fg-primary|--csi-bg-action"
  key_links:
    - from: assets/csi/csi-ui.js
      to: assets/csi/csi-state.js
      via: "import CSIController, CSI_STATES"
      pattern: "csi-state|CSIController"
---

<objective>
Реализовать UI-состояния CSI: баннер, попап-форма с оценкой и комментарием, экраны success (4–5 и 1–3) и error с Retry/Cancel. Использовать Figma-токены из RESEARCH.
</objective>

<execution_context>
@/Users/valeriatkaceva/.claude/get-shit-done/workflows/execute-plan.md
@/Users/valeriatkaceva/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/002-csi-komponent/002-RESEARCH.md
@.planning/phases/002-csi-komponent/002-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Стили и Figma-токены</name>
  <files>assets/csi/csi.css</files>
  <action>
Создать csi.css с CSS-переменными (Figma PSB-9282):
- --csi-fg-primary: #22263b
- --csi-bg-primary: #fff
- --csi-bg-action: #ffb800
- --csi-fg-accent: #344079
- --csi-border-secondary: #34407933
- --csi-bg-pressed: #22263b0d
- --csi-radius-m: 16px
- --csi-radius-l: 24px
Шрифт: Euclid Circular A, fallback Inter. Контейнер .csi-root { pointer-events: auto; } чтобы CSI был кликабелен поверх overlay с pointer-events: none. Баннер: position fixed, bottom 24px, right 24px, border-radius var(--csi-radius-l). Попап: центрирован, max-width 400px, border-radius var(--csi-radius-m), тень. Без скелетонов.
</action>
  <verify>Файл существует, grep "csi-fg-primary|csi-bg-action|csi-root" находит токены и контейнер</verify>
  <done>Figma-токены и базовые стили готовы</done>
</task>

<task type="auto">
  <name>Task 2: Баннер и попап-форма</name>
  <files>assets/csi/csi-ui.js</files>
  <action>
Создать csi-ui.js — модуль рендера UI:

1. Импорт CSIController, CSI_STATES, CHAT_SUPPORT_URL из csi-state.js
2. renderCSI(container) — главная функция: создаёт .csi-root, подписывается на переходы, рендерит по state
3. Баннер: кнопка/элемент в правом нижнем углу, текст «Оцените нас» или иконка. Default и hover (cursor, background transition)
4. Попап форма: оценка 1–5 — кликабельные цифры/звёзды (radio-подход); textarea для комментария с maxlength=1000 и счётчиком «X/1000»; кнопка «Сохранить» с loading-состоянием (disabled + текст «Отправка…» при SUBMITTING)
5. Закрытие: только Cancel, Close, X — клик вне попапа НЕ закрывает (не вешать overlay-backdrop с onClick close)
6. Привязка событий: клик баннера → transition('open'); при клике «Сохранить» считать rating/comment из формы и вызвать transition('submit', { rating, comment }); Cancel/Close → transition('close'); Retry → transition('retry'); Cancel в error → transition('cancel')
7. CTA «У меня срочный вопрос» — ссылка/кнопка с href=CHAT_SUPPORT_URL, target="_self" (переход на месте)
8. Ограничение: комментарий строго до 1000 символов (maxlength, валидация)
</action>
  <verify>csi-ui.js создаёт DOM для баннера и попапа, использует CSI_STATES для условного рендера, maxlength=1000 на textarea</verify>
  <done>Баннер и форма рендерятся, события привязаны к state machine</done>
</task>

<task type="auto">
  <name>Task 3: Экраны success и error</name>
  <files>assets/csi/csi-ui.js</files>
  <action>
Добавить в csi-ui.js рендер пост-субмит экранов:

1. SUCCESS_4_5: заголовок «Спасибо», кнопка «Закрыть» → transition('close')
2. SUCCESS_1_3: заголовок «Спасибо», кнопка «У меня срочный вопрос» (href=CHAT_SUPPORT_URL, target="_self"), кнопка «Закрыть»
3. ERROR: сообщение об ошибке, кнопка «Повторить» → transition('retry'), кнопка «Отмена» → transition('cancel')
4. При Retry — возврат в FORM с сохранёнными rating и comment (CSIController должен хранить draft)
5. При Cancel из error — закрытие попапа, возврат в BANNER
</action>
  <verify>Все три экрана (success 4-5, success 1-3, error) рендерятся в зависимости от state, Retry/Cancel работают</verify>
  <done>Success и error экраны реализованы, ветвление 4–5 vs 1–3 и retry/cancel соответствуют RESEARCH</done>
</task>

</tasks>

<verification>
- [ ] Баннер visible в правом нижнем углу, hover работает
- [ ] Попап: оценка 1–5, textarea max 1000 символов, Save с loading
- [ ] Success 4–5 и 1–3, Error + Retry/Cancel отображаются корректно
- [ ] Клик вне попапа не закрывает его
- [ ] CTA «У меня срочный вопрос» ведёт на CHAT_SUPPORT_URL
</verification>

<success_criteria>
- Все UI-состояния из RESEARCH реализованы
- Figma-токены применены, скелетонов нет
- UI готов к интеграции в prosebya-prototype-iframe.html (Plan 03)
</success_criteria>

<output>
После выполнения создать .planning/phases/002-csi-komponent/002-02-SUMMARY.md
</output>
