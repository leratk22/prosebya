# Phase 2: CSI-компонент — Research

**Researched:** 2026-02-24  
**Domain:** CSI survey component integration, state machine, web prototype  
**Confidence:** HIGH

## Summary

Фаза 2 разрабатывает компонент опросника CSI (Customer Satisfaction Index) для веб-ЛК ProSebya. Основной флоу: баннер в правом нижнем углу → попап с оценкой 1–5 и опциональным комментарием → отправка → экран благодарности с ветвлением по оценке (4–5 vs 1–3). Базой служит `prosebya-prototype-iframe.html`, где фон — iframe lk.prosebya.ru, а CSI монтируется в `#csi-overlay-root`.

Компонент имеет чётко описанную поведенческую логику (критерии показа баннера, ветвление по оценке, обработка ошибок), но ряд допущений по API и точкам входа остаётся открытым. Рекомендуется явная state machine для управления экранами попапа.

**Primary recommendation:** Разбить реализацию на подзадачи: state machine + условия показа баннера → UI-состояния баннера и попапа → интеграция с API (mock или реальный) → тестирование ветвлений и ошибок.

---

## 1. Scope и Non-Goals

### In Scope
- Компонент баннера CSI в правом нижнем углу (только на /lk)
- Попап с формой оценки 1–5 и опциональным комментарием (до 1000 символов)
- Ветвление пост-субмита: 4–5 → "Спасибо"; 1–3 → "Спасибо" + CTA в чат поддержки
- Обработка ошибок отправки (Retry / Cancel)
- Условия показа баннера (см. раздел 3)
- Монтирование в `#csi-overlay-root` поверх iframe-фона

### Out of Scope
- Скелетоны и состояния загрузки (по дизайну их нет)
- Учёт оценки из мобилки (веб учитывает только веб)
- Полноценная аутентификация (предполагается уже авторизованный пользователь)
- Реальное API backend (допускается mock для прототипа)

---

## 2. Экраны и UI-состояния

### Баннер (Banner)
| Состояние | Описание |
|-----------|----------|
| `default` | Баннер виден в правом нижнем углу |
| `hover` | Hover-состояние (desktop) |
| `draft/incomplete` | Оценка выбрана, но форма не отправлена — баннер остаётся на главной |

### Попап (Popup)
| Состояние | Описание |
|-----------|----------|
| `open_empty` | Открыт, оценка не выбрана |
| `rating_only` | Выбрана оценка, комментарий пустой |
| `rating_and_comment` | Выбрана оценка + есть комментарий |
| `submitting` | Loading состояния кнопки «Сохранить» при отправке |
| `error` | Ошибка отправки (500/network), Retry/Cancel |
| `success_4_5` | Подтверждение «Спасибо», кнопка «Закрыть» |
| `success_1_3` | Подтверждение «Спасибо» + «У меня срочный вопрос» |

### Дополнительные правила
- **Открытие из меню** (US2): раздел «Оцените нас» — отдельный экран/модал с тем же попапом или его вариантом (уточнить в Figma)
- **Закрытие**: Cancel/Close/X — закрытие попапа; клик вне области баннера **не** закрывает попап

---

## 3. Поведенческая логика и State Machine

### Критерии показа баннера
Баннер показывается **только на главной странице /lk** и при выполнении хотя бы одного условия:
- логин по номеру телефона;
- 3 и более консультаций;
- 2 и более просмотра контента;
- 3 и более логина.

Если пользователь уже оценил в мобилке — на вебе это **не учитываем** (баннер может показаться снова, если критерии выполнены).

### State Machine (предлагаемая схема)

```
                    ┌─────────────┐
                    │   hidden    │  (баннер не показан)
                    └──────┬──────┘
                           │ критерии выполнены
                           ▼
                    ┌─────────────┐
                    │   banner    │  ← баннер виден, попап закрыт
                    └──────┬──────┘
                           │ клик по баннеру / «Оцените нас»
                           ▼
                    ┌─────────────┐
              ┌─────│   form      │─────┐
              │     │ (rating ±   │     │
              │     │  comment)   │     │
              │     └──────┬──────┘     │ Cancel/Close
              │            │ Submit     │
              │            ▼            │
              │     ┌─────────────┐     │
              │     │  submitting │     │
              │     └──────┬──────┘     │
              │            │            │
              │     ┌──────┴──────┐     │
              │     │             │     │
              │  success      error     │
              │     │             │     │
              │     ▼             ▼     │
              │  ┌──────┐    ┌──────┐  │
              │  │thanks│    │ retry │──┼── Retry → form
              │  │ 4-5  │    │cancel │──┼── Cancel → banner
              │  └──┬───┘    └──────┘  │
              │     │                   │
              │  ┌──┴───┐               │
              │  │thanks│               │
              │  │ 1-3  │               │
              │  └──┬───┘               │
              │     │ Close             │
              └─────┴──────────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   banner    │  (баннер скрыт после успешного сабмита)
                    └─────────────┘
```

### Важные переходы
- После успешной отправки баннер **больше не показывается** на главной
- При ошибке: Retry → снова `form` с уже введёнными данными; Cancel → закрытие попапа
- В `success_1_3` кнопка «У меня срочный вопрос» ведёт по URL в чат поддержки **на месте текущей страницы** (переход в том же окне/вкладке)

---

## 4. API и интеграционные допущения

### Предполагаемый API
- **Endpoint:** `POST /submit` (или аналогичный — уточнить у бэкенда)
- **Payload:** `{ rating: 1..5, comment?: string }`
- **Success:** 2xx → переход в экран благодарности
- **Error:** 500 / network error → экран ошибки + Retry / Cancel

### Открытые вопросы
1. **Точный URL и метод:** Подтвердить `POST /submit`, базовый URL (lk.prosebya.ru или отдельный API)
2. **Аутентификация:** Как передаётся токен/сессия (cookie, header)? Прототип может работать без auth.
3. **Получение «последней оценки»:** При ошибке получения последней оценки — показывать форму сразу (без блокировки). Какой endpoint используется для проверки «уже оценивал»?
4. **Чат поддержки:** URL кнопки «У меня срочный вопрос» — нужен из дизайна или конфига

### Рекомендация для планирования
- Реализовать **mock API** (например, `fetch` с искусственной задержкой и ветвлением по rating) для прототипа
- Вынести базовый URL и endpoints в конфиг для последующей замены на реальный API

---

## 5. Риски и стратегии снижения

| Риск | Вероятность | Влияние | Стратегия снижения |
|------|-------------|---------|---------------------|
| API не готов к моменту реализации | Средняя | Среднее | Mock API в прототипе, чёткий контракт |
| Различия Figma vs base.html по токенам | Высокая | Низкое | Использовать Figma-токены для CSI; в RESEARCH зафиксировать оба набора |
| Критерии показа баннера требуют данных из бэкенда | Высокая | Высокое | Зафиксировать контракт данных; в прототипе — заглушки по флагам |
| Конфликт z-index / pointer-events с iframe | Низкая | Среднее | Overlay уже `pointer-events: none` на контейнере; CSI-элементы — `pointer-events: auto` |

---

## 6. Design Tokens (из Figma PSB-9282)

| Токен | Значение | Использование |
|-------|----------|---------------|
| FG/Primary | #22263b | Основной текст |
| BG/Primary | #fff | Фон |
| BG/Action | #ffb800 | Акцентные кнопки |
| FG/Accent | #344079 | Акцентный текст |
| Border/Button Secondary | #34407933 | Обводка второстепенных кнопок |
| BG/Pressed | #22263b0d | Состояние нажатия |
| Radius/M | 16px | Скругление карточек/попапа |
| Radius/L | 24px | Крупные элементы |
| Full | 999/1000 | Круглые элементы |
| Шрифт | Euclid Circular A | Title / Body / Label |

**Примечание:** В `prosebya-prototype-base.html` используются другие токены (brand.yellow #F5C542, brand.blue #5B72E5). CSI-компонент должен следовать Figma-токенам; при совмещении с base.html возможны расхождения — предусмотреть переопределение или общие переменные.

---

## 7. Planning Implications

### Рекомендуемая разбивка на подзадачи

1. **State machine и условия показа**
   - Определить состояния и переходы (явный FSM или useState)
   - Реализовать критерии показа баннера (заглушки для прототипа)
   - Покрыть: скрытие баннера после успешного сабмита

2. **UI баннера**
   - Баннер: default, hover; позиция правый нижний угол
   - Связь баннер ↔ открытие попапа

3. **UI попапа: форма**
   - Оценка 1–5 (радио или кликабельные звезды/цифры)
   - Поле комментария (textarea, лимит 1000 символов)
   - Кнопка «Сохранить» (loading-состояние)
   - Закрытие: Cancel/Close, клик вне баннера не закрывает

4. **UI попапа: пост-субмит**
   - Экран благодарности для 4–5 (кнопка «Закрыть»)
   - Экран благодарности для 1–3 + «У меня срочный вопрос»
   - Экран ошибки + Retry / Cancel

5. **Интеграция и окружение**
   - Mock API или реальный POST (по наличию)
   - Монтирование в `#csi-overlay-root`, `pointer-events` для интерактивности
   - Открытие из меню «Оцените нас» (если в scope)

6. **Верификация**
   - Прогон всех веток: 4–5, 1–3, ошибка, Retry, Cancel
   - Проверка лимита комментария, критериев показа баннера

---

## 8. User Stories (из Figma)

| ID | Описание | Приоритет |
|----|----------|-----------|
| US1 | Баннер в правом нижнем углу для авторизованного пользователя веб-ЛК | P0 |
| US2 | Открыть раздел «Оцените нас» из меню | P1 |
| US3 | Открыть форму из баннера, поставить оценку, опционально оставить комментарий | P0 |
| US4 | Отправить оценку без комментария | P0 |
| US5 | Добавить комментарий к оценке (опционально) | P0 |
| US6 | После отправки видеть подтверждение «Спасибо» | P0 |

---

## 9. Open Questions

1. **«Оцените нас» из меню:** Открывает тот же попап или отдельный экран? Нужна ли другая вёрстка?
2. **Точный URL чата поддержки** для кнопки «У меня срочный вопрос»
3. **Формат ответа API** при успехе (нужен ли payload для логики или достаточно status)
4. **Совместимость с prosebya-prototype-base.html:** Использовать base.html как фон вместо iframe или оставить только iframe-вариант?

---

## 10. Sources

### Primary
- Figma file `NvzcX700bseJnlyBwa2zFv`, секция PSB-9282
- `prosebya-prototype-iframe.html` — целевой хост для CSI
- `prosebya-prototype-base.html` — статичная копия, альтернативная база

### Secondary
- `.planning/ROADMAP.md` — цели фазы 2
- User-provided extraction из Figma (flow, user stories, constraints, tokens)

---

## Metadata

**Confidence breakdown:**
- Scope & UI states: HIGH — чётко описано в Figma/контексте
- State machine: HIGH — логика однозначна
- API: LOW — допущения, требуют уточнения
- Design tokens: HIGH — извлечены из Figma

**Research date:** 2026-02-24  
**Valid until:** 2026-03-24
